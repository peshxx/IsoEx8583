#include <string.h>
#include "IsoEx.h"

static int highbit, lowbit;
static int asc_ebcdic(int in_asc);
static int ebcdic_asc(int in_ebc) ;
static void db_asctoebc( void );
static void db_ebctoasc( void );
static void code_asctoebc( void );
static void code_ebctoasc( void );


/*   get  ascll code  value  for a bit  of  input  string  */
static int turnint(int intval1)
{
int turnvar,turnvar1;       
int intval;

	turnvar=intval1;
	turnvar1 = abs( 0xff + turnvar + 1);
	if ( ( intval1 >= 0 ) && ( intval1 < 0x80 ) )         
		intval=turnvar;
	else
		intval=turnvar1;
	return(intval); 
}
void Asc2Bcd(unsigned char *bcd, unsigned char *asc, int len, int r_align)
{
	int i, flag = 0;
	unsigned char ch;

	memset(bcd, 0, (len + 1) / 2);

	if ((len % 2) && r_align) flag = 1;

	for (i = 0; i < len; i++) {
		if (asc[i] >= 'a') ch = asc[i] - 'a' + 10;
		else if (asc[i] >= 'A') ch = asc[i] - 'A' + 10;
		else if (asc[i] >= '0') ch = asc[i] - '0';
		else ch = 0;
		if ((i + flag) % 2) bcd[(i + flag) / 2] |= (ch & 0x0F);
		else bcd[(i + flag) / 2] |= (ch << 4);
	}
}

void Bcd2Asc(unsigned char *asc, unsigned char *bcd, int len, int r_align)
{
	int i, flag = 0;

	if ((len % 2) && r_align) flag = 1;

	for (i = 0; i < len; i++) {
		if ((i + flag) % 2) asc[i] = bcd[(i + flag) / 2] & 0x0F;
		else asc[i] = (bcd[(i + flag) / 2] >> 4);
		asc[i] += (asc[i] > 9) ? ('A' - 10) : '0';
	}
}

void EBcd2Asc(char *outstr,char *instr,int lenth)
{
int invar,outvar;
int intval,intval1;

	outvar=0;

	/* Turn  A String */
	for (invar=0;invar<=lenth;invar++) {
		intval1= instr[invar];
		intval = turnint(intval1);
		if (intval==0x0e) { /* Chinese Code */
			invar++;
			intval1=instr[invar];
			intval=turnint(intval1);
			while ((invar<=lenth) && (intval!=0x0f)) {
				highbit=intval;
				invar++;
				intval1=instr[invar];
				intval=turnint(intval1);
				lowbit=intval;

/*  exchange chinese from as/400 to unix */
				if (highbit>=0x48) 
					code_ebctoasc( );
				else 
/*  exchange chinese char from as/400 to unix */
					db_ebctoasc( );

				outstr[outvar]=highbit;
				outvar++;
				outstr[outvar]=lowbit;
				outvar++;
				invar++;
				intval1=instr[invar];
				intval=turnint(intval1);
			}

			/*   insert  two  space    */
			outstr[outvar]=0x20;
			outvar++;
			outstr[outvar]=0x20;
			outvar++;
		}
		else { /*   ascll  code   */
			highbit=intval;
			switch(highbit) {
			/*  char   '[' ']' '|' '!' '^'   */
			case 0x5a:
				outstr[outvar]=0x21;
				break;
			case 0xa0:
				outstr[outvar]=0x5b;
				break;
			case 0xb0:
				outstr[outvar]=0x5d;
				break;
			case 0x4f:
				outstr[outvar]=0x7c;
				break;
			case 0x6a:
				outstr[outvar]=0x20;
				break;
			default:  
			/*  exchange ebcdic code to ascll code */
				outstr[outvar]=ebcdic_asc(highbit);
				break;
			}
			outvar++;
		}
	}
	outvar--;
}

void Asc2EBcd(char *outstr,char *instr,int lenth)
{
int num;                    /*   space  number   */
int invar,outvar;           /*   in/out  point   */
int intval,intval1;         /*   get ascll value  */

	/*   turn  a string   */
	num=0;
	outvar=0;
	for (invar=0;invar<=lenth;invar++) {
		intval1=instr[invar];
		intval=turnint(intval1);

		/*   chinese  code  */
		if (intval>=0x80) {
			outstr[outvar]=0x0e;              /*    add  0e    */
			outvar++;
			while ((invar<=lenth) && (intval>=0x80)) {
				highbit=intval;
				invar++;
				intval1=instr[invar];
				intval=turnint(intval1);
				lowbit=intval; 

				if (highbit>=0xb0)
/* exchange  chinese from unix to as/400 */
					code_asctoebc( );
				else 
/*  exchange  chinese  char from unix to as/400 */
					db_asctoebc( );

				outstr[outvar]=highbit;
				outvar++;
				outstr[outvar]=lowbit;
				outvar++;
				invar++;
				intval1=instr[invar];
				intval=turnint(intval1);
			}
			outstr[outvar]=0x0f;
			outvar++;
			invar--;
			num=num+2;    /*   two  space   */
		}
		else {
			highbit=intval;      /*    ascll  code   */
			if ( highbit == 0x20 ) {          /*    space    */
				if (num!=0) {
					num--;
					continue;
				}
			}

			/*   char  '[' ']' '|' '!' '^'     */
			switch(highbit) {
			case 0x21:
				outstr[outvar]=0x5a;
				break;
			case 0x5b:
				outstr[outvar]=0xa0;
				break;
			case 0x5d:
				outstr[outvar]=0xb0;
				break;
			case 0x7c:
				/*   outstr[outvar]=0x4f;*/
				outstr[outvar]=0x6a;
				break;
			default:
		/*   exchange  ascll code  from  unix  to  as/400  */
				outstr[outvar]=asc_ebcdic(highbit);
				break;
			}
			outvar++;
		}
     }
     outvar--;
}

void AtoE(char *s,int len)
{
char buf[2048];
	memset( buf , 0 , sizeof( buf ) );
	Asc2EBcd(buf,s,len);
	memcpy  (s,buf,len);
}

void EtoA(char *s,int len)
{
char buf[2048];

	memset( buf , 0 , sizeof( buf ) );
	EBcd2Asc(buf,s,len);
	memcpy  (s,buf,len);
}


/* EXCHANGE  ASCll CODE TO EBCDIC */

static int asc_ebcdic(int in_asc)
{
static int l_asctoebc[256]={0,0,0,0,0,0,0,0,0,0,0,       
                          0,0,0,0,0,0,0,0,0,0,          /*   ten   bit   */
                          0,0,0,0,0,0,0,0,0,0,
                          0,64,79,127,123,91,108,80,125,77,
                          93,92,78,107,96,75,97,240,241,242,  
                          243,244,245,246,247,248,249,122,94,76, 
                          126,110,111,124,193,194,195,196,197,198,
                          199,200,201,209,210,211,212,213,214,215,
                          216,217,226,227,228,229,230,231,232,233,
                          74,224,90,95,109,121,129,130,131,132,
                          133,134,135,136,137,145,146,147,148,149,
                          150,151,152,153,162,163,164,165,166,167,
                          168,169,192,106,208,161,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0};

	return l_asctoebc[in_asc];
}


/*   exchange  EBCDIC  code  into  ASCll    code   */

static int ebcdic_asc(int in_ebc)      /*    input  ebcdic  code    */
{
static int l_ebctoasc[256]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,32,0,0,0,0,0,         /*    ten  bit  */
                          0,0,0,0,91,46,60,40,43,33,
                          38,0,0,0,0,0,0,0,0,0,
                          93,36,42,41,59,94,45,47,0,0,
                          0,0,0,0,0,0,124,44,37,95,
                          62,63,0,0,0,0,0,0,0,0,
                          0,96,58,35,64,39,61,34,0,97,
                          98,99,100,101,102,103,104,105,0,0,
                          0,0,0,0,0,106,107,108,109,110,
                          111,112,113,114,0,0,0,0,0,0,
                          0,126,115,116,117,118,119,120,121,122,
                          0,0,0,0,0,0,0,0,0,0,
                          0,0,0,0,0,0,0,0,0,0,
                          0,0,123,65,66,67,68,69,70,71,
                          72,73,0,0,0,0,0,0,125,74,
                          75,76,77,78,79,80,81,82,0,0,
                          0,0,0,0,92,0,83,84,85,86,
                          87,88,89,90,0,0,0,0,0,0,
                          48,49,50,51,52,53,54,55,56,57,
                          0,0,0,0,0,0};

	return l_ebctoasc[in_ebc];
}

/* EXCHANGE  CHINESE  CHARACTER  ASCll_EBCDIC  */
/*   unix  chinese char is changed as/400 chinese char   */
int asctoebc [260] [2] = {0x40,0x40,0x43,0x44,0x43,0x41,0x43,0x45,0x45,
                         0x45,0x45,0x46,0x44,0x60,0x44,0x5b,0x44,0x5d,
                         0x44,0x4a,0x43,0xa1,0x44,0x7c,0x44,0x7f,0x44,
                         0x61,0x44,0x71,0x44,0x62,0x44,0x72,0x44,0x63,
                         0x44,0x73,0x44,0x64,0x44,0x74,0x44,0x65,0x44,
                         0x75,0x43,0x42,0x43,0x43,0x44,0x42,0x44,0x43,
                         0x45,0x5b,0x45,0x5c,0x44,0x66,0x44,0x76,0x44,
                         0x4b,0x44,0x7a,0x44,0x7b,0x45,0x62,0x45,0x63,
                         0x45,0x64,0x45,0x65,0x45,0x66,0x45,0x67,0x45,
                         0x68,0x45,0x69,0x45,0x6a,0x45,0x6b,0x45,0x6c,
                         0x45,0x6d,0x45,0x6e,0x45,0x6f,0x45,0x70,0x45,
                         0x71,0x45,0x72,0x45,0x73,0x45,0x74,0x45,0x75,
                         0x45,0x76,0x45,0x77,0x44,0x4c,0x45,0x79,0x45,
                         0x7a,0x44,0x67,0x44,0x77,0x44,0x4d,0x44,0x78,
                         0x44,0x68,0x44,0x69,0x44,0x79,0x44,0xed,0x44,
                         0xee,0x44,0xef,0x44,0x4e,0x42,0xe0,0x45,0x88,
                         0x43,0x4a,0x42,0x4a,0x45,0x8b,0x44,0x6a,0x44,
                         0x6e,0x44,0xe5,0x44,0xe6,0x44,0xe0,0x44,0xe1,
                         0x44,0xe4,0x44,0xe7,0x44,0xe8,0x44,0xe9,0x44,
                         0xea,0x44,0xe2,0x44,0xe3,0x44,0x6b,0x44,0xf0,
                         0x44,0xf1,0x44,0xf2,0x44,0xf3,0x44,0x7d,0x45,
                         0xb1,0x45,0xb2,0x45,0xb3,0x45,0xb4,0x45,0xb5,
                         0x45,0xb6,0x45,0xb7,0x45,0xb8,0x45,0xb9,0x45,
                         0xba,0x45,0xbb,0x45,0xbc,0x45,0xbd,0x45,0xbe,
                         0x45,0xbf,0x45,0xc0,0x45,0xc1,0x45,0xc2,0x45,
                         0xc3,0x45,0xc4,0x45,0xc5,0x45,0xc6,0x45,0xc7,
                         0x45,0xc8,0x45,0xc9,0x45,0xca,0x45,0xcb,0x45,
                         0xcc,0x45,0xcd,0x45,0xce,0x45,0xcf,0x45,0xd0,
                         0x45,0xd1,0x45,0xd2,0x45,0xd3,0x45,0xd4,0x45,
                         0xd5,0x45,0xd6,0x45,0xd7,0x45,0xd8,0x45,0xe1,
                         0x45,0xe2,0x45,0xe3,0x45,0xe4,0x45,0xe5,0x45,
                         0xe6,0x45,0xe7,0x45,0xe8,0x45,0xe9,0x45,0xea,
                         0x45,0xf1,0x45,0xf2,0x45,0xf3,0x45,0xf4,0x45,
                         0xf5,0x45,0xf6,0x45,0xf7,0x45,0xf8,0x45,0xf9, 
                         0x45,0xfa,0x41,0xf1,0x41,0xf2,0x41,0xf3,0x41,
                         0xf4,0x41,0xf5,0x41,0xf6,0x41,0xf7,0x41,0xf8,
                         0x41,0xf9,0x41,0xfa,0x41,0xfb,0x41,0xfc,0x42,
                         0x5a,0x42,0x7f,0x42,0x7b,0x42,0x5b,0x42,0x6c, 
                         0x42,0x50,0x44,0x50,0x42,0x4d,0x42,0x5d,0x42,
                         0x5c,0x42,0x4e,0x42,0x6b,0x42,0x60,0x42,0x4b,
                         0x42,0x61,0x42,0xf0,0x42,0xf1,0x42,0xf2,0x42,
                         0xf3,0x42,0xf4,0x42,0xf5,0x42,0xf6,0x42,0xf7,
                         0x42,0xf8,0x42,0xf9,0x42,0x7a,0x42,0x5e,0x42,
                         0x4c,0x42,0x7e,0x42,0x6e,0x42,0x6f,0x42,0x7c,
                         0x42,0xc1,0x42,0xc2,0x42,0xc3,0x42,0xc4,0x42,
                         0xc5,0x42,0xc6,0x42,0xc7,0x42,0xc8,0x42,0xc9,
                         0x42,0xd1,0x42,0xd2,0x42,0xd3,0x42,0xd4,0x42,
                         0xd5,0x42,0xd6,0x42,0xd7,0x42,0xd8,0x42,0xd9,
                         0x42,0xe2,0x42,0xe3,0x42,0xe4,0x42,0xe5,0x42,
                         0xe6,0x42,0xe7,0x42,0xe8,0x42,0xe9,0x44,0x44,
                         0x43,0xe0,0x44,0x45,0x44,0x70,0x42,0x6d,0x42,
                         0x79,0x42,0x81,0x42,0x82,0x42,0x83,0x42,0x84,
                         0x42,0x85,0x42,0x86,0x42,0x87,0x42,0x88,0x42,
                         0x89,0x42,0x91,0x42,0x92,0x42,0x93,0x42,0x94,
                         0x42,0x95,0x42,0x96,0x42,0x97,0x42,0x98,0x42,
                         0x99,0x42,0xa2,0x42,0xa3,0x42,0xa4,0x42,0xa5,
                         0x42,0xa6,0x42,0xa7,0x42,0xa8,0x42,0xa9,0x42,
                         0xc0,0x42,0x4f,0x42,0xd0,0x42,0xa1};
 int ebctoasc [260] [2] = {0xa1,0xa1,0xa1,0xa2,0xa1,0xa3,0xa1,0xa4,0xa1,
                         0xa5,0xa1,0xa6,0xa1,0xa7,0xa1,0xa8,0xa1,0xa9,
                         0xa1,0xaa,0xa1,0xab,0xa1,0xac,0xa1,0xad,0xa1,
                         0xae,0xa1,0xaf,0xa1,0xb0,0xa1,0xb1,0xa1,0xb2,
                         0xa1,0xb3,0xa1,0xb4,0xa1,0xb5,0xa1,0xb6,0xa1,
                         0xb7,0xa1,0xb8,0xa1,0xb9,0xa1,0xba,0xa1,0xbb,
                         0xa1,0xbc,0xa1,0xbd,0xa1,0xbe,0xa1,0xbf,0xa1,
                         0xc0,0xa1,0xc1,0xa1,0xc2,0xa1,0xc3,0xa1,0xc4,
                         0xa1,0xc5,0xa1,0xc6,0xa1,0xc7,0xa1,0xc8,0xa1,
                         0xc9,0xa1,0xca,0xa1,0xcb,0xa1,0xcc,0xa1,0xcd,
                         0xa1,0xce,0xa1,0xcf,0xa1,0xd0,0xa1,0xd1,0xa1,
                         0xd2,0xa1,0xd3,0xa1,0xd4,0xa1,0xd5,0xa1,0xd6,
                         0xa1,0xd7,0xa1,0xd8,0xa1,0xd9,0xa1,0xda,0xa1,
                         0xdb,0xa1,0xdc,0xa1,0xdd,0xa1,0xde,0xa1,0xdf,
                         0xa1,0xe0,0xa1,0xe1,0xa1,0xe2,0xa1,0xe3,0xa1,
                         0xe4,0xa1,0xe5,0xa1,0xe6,0xa1,0xe7,0xa1,0xe8,
                         0xa1,0xe9,0xa1,0xea,0xa1,0xeb,0xa1,0xec,0xa1,
                         0xed,0xa1,0xee,0xa1,0xef,0xa1,0xf0,0xa1,0xf1,
                         0xa1,0xf2,0xa1,0xf3,0xa1,0xf4,0xa1,0xf5,0xa1,
                         0xf6,0xa1,0xf7,0xa1,0xf8,0xa1,0xf9,0xa1,0xfa,
                         0xa1,0xfb,0xa1,0xfc,0xa1,0xfd,0xa1,0xfe,0xa2,
                         0xb1,0xa2,0xb2,0xa2,0xb3,0xa2,0xb4,0xa2,0xb5,
                         0xa2,0xb6,0xa2,0xb7,0xa2,0xb8,0xa2,0xb9,0xa2,
                         0xba,0xa2,0xbb,0xa2,0xbc,0xa2,0xbd,0xa2,0xbe,
                         0xa2,0xbf,0xa2,0xc0,0xa2,0xc1,0xa2,0xc2,0xa2,
                         0xc3,0xa2,0xc4,0xa2,0xc5,0xa2,0xc6,0xa2,0xc7,
                         0xa2,0xc8,0xa2,0xc9,0xa2,0xca,0xa2,0xcb,0xa2,
                         0xcc,0xa2,0xcd,0xa2,0xce,0xa2,0xcf,0xa2,0xd0,
                         0xa2,0xd1,0xa2,0xd2,0xa2,0xd3,0xa2,0xd4,0xa2,
                         0xd5,0xa2,0xd6,0xa2,0xd7,0xa2,0xd8,0xa2,0xd9,
                         0xa2,0xda,0xa2,0xdb,0xa2,0xdc,0xa2,0xdd,0xa2,
                         0xde,0xa2,0xdf,0xa2,0xe0,0xa2,0xe1,0xa2,0xe2,
                         0xa2,0xe5,0xa2,0xe6,0xa2,0xe7,0xa2,0xe8,0xa2,
                         0xe9,0xa2,0xea,0xa2,0xeb,0xa2,0xec,0xa2,0xed,
                         0xa2,0xee,0xa2,0xf1,0xa2,0xf2,0xa2,0xf3,0xa2,
                         0xf4,0xa2,0xf5,0xa2,0xf6,0xa2,0xf7,0xa2,0xf8,
                         0xa2,0xf9,0xa2,0xfa,0xa2,0xfb,0xa2,0xfc,0xa3,
                         0xa1,0xa3,0xa2,0xa3,0xa3,0xa3,0xa4,0xa3,0xa5,
                         0xa3,0xa6,0xa3,0xa7,0xa3,0xa8,0xa3,0xa9,0xa3,
                         0xaa,0xa3,0xab,0xa3,0xac,0xa3,0xad,0xa3,0xae,
                         0xa3,0xaf,0xa3,0xb0,0xa3,0xb1,0xa3,0xb2,0xa3,
                         0xb3,0xa3,0xb4,0xa3,0xb5,0xa3,0xb6,0xa3,0xb7,
                         0xa3,0xb8,0xa3,0xb9,0xa3,0xba,0xa3,0xbb,0xa3,
                         0xbc,0xa3,0xbd,0xa3,0xbe,0xa3,0xbf,0xa3,0xc0,
                         0xa3,0xc1,0xa3,0xc2,0xa3,0xc3,0xa3,0xc4,0xa3,
                         0xc5,0xa3,0xc6,0xa3,0xc7,0xa3,0xc8,0xa3,0xc9,
                         0xa3,0xca,0xa3,0xcb,0xa3,0xcc,0xa3,0xcd,0xa3,
                         0xce,0xa3,0xcf,0xa3,0xd0,0xa3,0xd1,0xa3,0xd2,
                         0xa3,0xd3,0xa3,0xd4,0xa3,0xd5,0xa3,0xd6,0xa3,
                         0xd7,0xa3,0xd8,0xa3,0xd9,0xa3,0xda,0xa3,0xdb,
                         0xa3,0xdc,0xa3,0xdd,0xa3,0xde,0xa3,0xdf,0xa3,
                         0xe0,
                         0xa3,0xe1,0xa3,0xe2,0xa3,0xe3,0xa3,0xe4,0xa3,
                         0xe5,0xa3,0xe6,0xa3,0xe7,0xa3,0xe8,0xa3,0xe9,
                         0xa3,0xea,0xa3,0xeb,0xa3,0xec,0xa3,0xed,0xa3,
                         0xee,0xa3,0xef,0xa3,0xf0,0xa3,0xf1,0xa3,0xf2,
                         0xa3,0xf3,0xa3,0xf4,0xa3,0xf5,0xa3,0xf6,0xa3,
                         0xf7,0xa3,0xf8,0xa3,0xf9,0xa3,0xfa,0xa3,0xfb,
                         0xa3,0xfc,0xa3,0xfd,0xa3,0xfe};


/*   unix  chinese char is changed as/400 chinese char   */

static void db_asctoebc( )
{
int arr,turnvar,turnvar1;

	if (highbit==0xa9)
		/* trans MAKE TABLE SIGN (09 AREA) */
		highbit=highbit-0x63;
	else {
		for ( arr=0;arr<=259; ++arr)  {
			turnvar=ebctoasc[arr][0];
			turnvar1=ebctoasc[arr][1];
			if (turnvar==highbit && turnvar1==lowbit) break;
		}
		highbit=asctoebc[arr] [0];
		lowbit=asctoebc[arr] [1];
	}
	return;
}

/*   as/400  chinese char is changed unix chinese char   */

static void db_ebctoasc( )
{
int arr,turnvar,turnvar1;

	if (highbit==0x46)
		/* trans MAKE TABLE SIGN (09 AREA) */
		highbit=highbit+0x63;
	else {
		for ( arr=0;arr<=259; ++arr)   {
			turnvar=asctoebc[arr][0];
			turnvar1=asctoebc[arr][1];
			if (turnvar==highbit && turnvar1==lowbit) break;
		}
		highbit=ebctoasc[arr] [0];
		lowbit=ebctoasc[arr] [1];
	}
	return;
}

/*	TURN CHINESE CODE FROM UNIX TO AS/400  */
static void code_asctoebc()
{
int highbit1,lowbit1,outhigh,outlow;

	highbit1=highbit-0xb0;

	/*  turn   high  bit   */
	if (highbit1%2!=0) highbit1++;
	highbit1/=2;
	outhigh=highbit1+0x48;

	/*  turn  lower  bit   */
	if (highbit%2!=0)  {
		if (lowbit<0xe0)
			outlow=lowbit-0x60;
		else
			outlow=lowbit-0x5f;
	}
	else 
		outlow=lowbit-1;

	/*  send  output  */
	highbit=outhigh;
	lowbit=outlow;
	return;
}

/* TURN CHINESE CODE FROM AS/400  TO  UNIX  */

static void code_ebctoasc( )
{
int highbit1,lowbit1,outhigh,outlow;

	if (highbit!=0x48) {
		highbit1=highbit-0x48;
		highbit1*=2;
		if (lowbit<=0x9f) highbit1--;

		outhigh=highbit1+0xb0;
		if (lowbit<=0x9f)  {
			if (lowbit<0x81)
				outlow=lowbit+0x60;
			else
				outlow=lowbit+0x5f;
		}
		else 
			outlow=lowbit+1;
	}
	else {
		outhigh=0xb0;
		outlow=lowbit+1;
	};

	/*  send  output  */
	highbit=outhigh;
	lowbit=outlow;
	return;
}
